{"ast":null,"code":"// src/firebase/messages.js\nimport { collection, addDoc, doc, getDoc, getDocs, updateDoc, query, where, orderBy, arrayUnion } from \"firebase/firestore\";\nimport { db } from \"./config\";\nconst THREADS_COL = \"threads\";\n\n// Get threads for a user\nexport async function getUserThreads(userId) {\n  const q = query(collection(db, THREADS_COL), where(\"participants\", \"array-contains\", userId), orderBy(\"updatedAt\", \"desc\"));\n  const snap = await getDocs(q);\n  return snap.docs.map(d => ({\n    id: d.id,\n    ...d.data()\n  }));\n}\n\n// Get a single thread\nexport async function getThread(threadId) {\n  const ref = doc(db, THREADS_COL, threadId);\n  const snap = await getDoc(ref);\n  return snap.exists() ? {\n    id: snap.id,\n    ...snap.data()\n  } : null;\n}\n\n// Create a new thread and first message\nexport async function createThread(participants, initialMessage) {\n  const now = new Date();\n  const threadRef = await addDoc(collection(db, THREADS_COL), {\n    participants,\n    createdAt: now,\n    updatedAt: now,\n    lastMessage: initialMessage.text || \"\",\n    typing: {} // userId -> boolean\n  });\n  const baseMsg = {\n    ...initialMessage,\n    createdAt: now,\n    // Sender has obviously \"read\" their own message\n    readBy: initialMessage.senderId ? [initialMessage.senderId] : []\n  };\n  await addDoc(collection(threadRef, \"messages\"), baseMsg);\n  return threadRef.id;\n}\n\n// Send a message\nexport async function sendMessage(threadId, message) {\n  const threadRef = doc(db, THREADS_COL, threadId);\n  const now = new Date();\n  const baseMsg = {\n    ...message,\n    createdAt: now\n  };\n\n  // Ensure sender is in readBy array\n  if (!Array.isArray(baseMsg.readBy)) {\n    baseMsg.readBy = message.senderId ? [message.senderId] : [];\n  }\n  await addDoc(collection(threadRef, \"messages\"), baseMsg);\n  await updateDoc(threadRef, {\n    updatedAt: now,\n    lastMessage: message.text || \"\"\n  });\n}\n\n// Load messages for a thread\nexport async function getThreadMessages(threadId) {\n  const q = query(collection(db, `${THREADS_COL}/${threadId}/messages`), orderBy(\"createdAt\", \"asc\"));\n  const snap = await getDocs(q);\n  return snap.docs.map(d => ({\n    id: d.id,\n    ...d.data()\n  }));\n}\n\n// ðŸ”µ Typing indicator: set typing state for a user\nexport async function setThreadTyping(threadId, userId, isTyping) {\n  if (!threadId || !userId) return;\n  const threadRef = doc(db, THREADS_COL, threadId);\n  await updateDoc(threadRef, {\n    [`typing.${userId}`]: isTyping\n  });\n}\n\n// ðŸ”µ Read receipts: mark all messages in a thread as read by a user\nexport async function markThreadMessagesRead(threadId, userId) {\n  if (!threadId || !userId) return;\n  const msgsCol = collection(db, `${THREADS_COL}/${threadId}/messages`);\n  const snap = await getDocs(msgsCol);\n  const updates = [];\n  for (const docSnap of snap.docs) {\n    const data = docSnap.data();\n    const readBy = Array.isArray(data.readBy) ? data.readBy : [];\n    if (!readBy.includes(userId)) {\n      updates.push(updateDoc(docSnap.ref, {\n        readBy: arrayUnion(userId)\n      }));\n    }\n  }\n  if (updates.length > 0) {\n    await Promise.all(updates);\n  }\n}","map":{"version":3,"names":["collection","addDoc","doc","getDoc","getDocs","updateDoc","query","where","orderBy","arrayUnion","db","THREADS_COL","getUserThreads","userId","q","snap","docs","map","d","id","data","getThread","threadId","ref","exists","createThread","participants","initialMessage","now","Date","threadRef","createdAt","updatedAt","lastMessage","text","typing","baseMsg","readBy","senderId","sendMessage","message","Array","isArray","getThreadMessages","setThreadTyping","isTyping","markThreadMessagesRead","msgsCol","updates","docSnap","includes","push","length","Promise","all"],"sources":["C:/Users/Floyd/Desktop/Websites/HIAWTO/hi-awto-clean/src/firebase/messages.js"],"sourcesContent":["// src/firebase/messages.js\r\nimport {\r\n  collection,\r\n  addDoc,\r\n  doc,\r\n  getDoc,\r\n  getDocs,\r\n  updateDoc,\r\n  query,\r\n  where,\r\n  orderBy,\r\n  arrayUnion,\r\n} from \"firebase/firestore\";\r\nimport { db } from \"./config\";\r\n\r\nconst THREADS_COL = \"threads\";\r\n\r\n// Get threads for a user\r\nexport async function getUserThreads(userId) {\r\n  const q = query(\r\n    collection(db, THREADS_COL),\r\n    where(\"participants\", \"array-contains\", userId),\r\n    orderBy(\"updatedAt\", \"desc\")\r\n  );\r\n  const snap = await getDocs(q);\r\n  return snap.docs.map((d) => ({ id: d.id, ...d.data() }));\r\n}\r\n\r\n// Get a single thread\r\nexport async function getThread(threadId) {\r\n  const ref = doc(db, THREADS_COL, threadId);\r\n  const snap = await getDoc(ref);\r\n  return snap.exists() ? { id: snap.id, ...snap.data() } : null;\r\n}\r\n\r\n// Create a new thread and first message\r\nexport async function createThread(participants, initialMessage) {\r\n  const now = new Date();\r\n\r\n  const threadRef = await addDoc(collection(db, THREADS_COL), {\r\n    participants,\r\n    createdAt: now,\r\n    updatedAt: now,\r\n    lastMessage: initialMessage.text || \"\",\r\n    typing: {}, // userId -> boolean\r\n  });\r\n\r\n  const baseMsg = {\r\n    ...initialMessage,\r\n    createdAt: now,\r\n    // Sender has obviously \"read\" their own message\r\n    readBy: initialMessage.senderId ? [initialMessage.senderId] : [],\r\n  };\r\n\r\n  await addDoc(collection(threadRef, \"messages\"), baseMsg);\r\n\r\n  return threadRef.id;\r\n}\r\n\r\n// Send a message\r\nexport async function sendMessage(threadId, message) {\r\n  const threadRef = doc(db, THREADS_COL, threadId);\r\n  const now = new Date();\r\n\r\n  const baseMsg = {\r\n    ...message,\r\n    createdAt: now,\r\n  };\r\n\r\n  // Ensure sender is in readBy array\r\n  if (!Array.isArray(baseMsg.readBy)) {\r\n    baseMsg.readBy = message.senderId ? [message.senderId] : [];\r\n  }\r\n\r\n  await addDoc(collection(threadRef, \"messages\"), baseMsg);\r\n\r\n  await updateDoc(threadRef, {\r\n    updatedAt: now,\r\n    lastMessage: message.text || \"\",\r\n  });\r\n}\r\n\r\n// Load messages for a thread\r\nexport async function getThreadMessages(threadId) {\r\n  const q = query(\r\n    collection(db, `${THREADS_COL}/${threadId}/messages`),\r\n    orderBy(\"createdAt\", \"asc\")\r\n  );\r\n  const snap = await getDocs(q);\r\n  return snap.docs.map((d) => ({ id: d.id, ...d.data() }));\r\n}\r\n\r\n// ðŸ”µ Typing indicator: set typing state for a user\r\nexport async function setThreadTyping(threadId, userId, isTyping) {\r\n  if (!threadId || !userId) return;\r\n\r\n  const threadRef = doc(db, THREADS_COL, threadId);\r\n  await updateDoc(threadRef, {\r\n    [`typing.${userId}`]: isTyping,\r\n  });\r\n}\r\n\r\n// ðŸ”µ Read receipts: mark all messages in a thread as read by a user\r\nexport async function markThreadMessagesRead(threadId, userId) {\r\n  if (!threadId || !userId) return;\r\n\r\n  const msgsCol = collection(db, `${THREADS_COL}/${threadId}/messages`);\r\n  const snap = await getDocs(msgsCol);\r\n\r\n  const updates = [];\r\n  for (const docSnap of snap.docs) {\r\n    const data = docSnap.data();\r\n    const readBy = Array.isArray(data.readBy) ? data.readBy : [];\r\n\r\n    if (!readBy.includes(userId)) {\r\n      updates.push(\r\n        updateDoc(docSnap.ref, {\r\n          readBy: arrayUnion(userId),\r\n        })\r\n      );\r\n    }\r\n  }\r\n\r\n  if (updates.length > 0) {\r\n    await Promise.all(updates);\r\n  }\r\n}\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}