rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================
    //  Admin Users Only
    // ============================
    function isAdmin() {
      return request.auth != null &&
             request.auth.token.admin == true;
    }

    // ============================
    //  Messaging Threads
    //  threads/{threadId}
    // ============================
    match /threads/{threadId} {

      // (1) Admin: full access
      allow read, write: if isAdmin();

      // (2) Regular user: must be participant
      allow read, update: if request.auth != null
                          && request.auth.uid in resource.data.participants;

      // (3) Create thread allowed if sender is participant
      allow create: if request.auth != null
                    && request.auth.uid in request.resource.data.participants;

      // Prevent deleting threads except admin
      allow delete: if isAdmin();

      // ==========================================
      //  Thread Messages
      //  threads/{threadId}/messages/{messageId}
      // ==========================================
      match /messages/{messageId} {

        // Admin full access
        allow read, write: if isAdmin();

        // Participants may read or send messages
        allow read, write: if request.auth != null
                           && request.auth.uid in get(/databases/$(databas

                           match /listings/{id} {
  allow read: if true;
  allow write: if request.auth != null && request.auth.token.role == "admin";
}

match /listings/{listingId} {
  allow read;

  // Only admins can approve/deny
  allow update: if request.auth != null &&
                request.auth.token.admin == true;

  // Normal users can create/edit only their own listings
  allow create, update: if request.auth != null &&
                        request.auth.uid == resource.data.ownerId;
}
