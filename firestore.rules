// =============================
// HI-AWTO ‚Äî FIRESTORE RULES
// Production Security Model
// =============================

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -----------------------------------
    // üéØ  UTILITIES
    // -----------------------------------
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isSignedIn() && request.auth.token.admin == true;
    }

    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    // -----------------------------------
    // üßç USERS COLLECTION
    // users/{uid}
    // -----------------------------------
    match /users/{uid} {
      allow read: if isAdmin() || isOwner(uid);
      allow write: if isOwner(uid);
    }

    // -----------------------------------
    // üè° LISTINGS
    // listings/{listingId}
    // -----------------------------------
    match /listings/{listingId} {

      // Public READ rules:
      // Only "approved" listings are publicly visible.
      allow get, list: if resource.data.status == "approved";

      // Signed-in owners can create listings
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;

      // Owners can update ONLY their own listing
      // BUT may NOT modify admin-only fields
      allow update: if isOwner(resource.data.ownerId)
        && !( "status" in request.resource.data )         // owner cannot approve/reject
        && !( "fraud" in request.resource.data )          // owner cannot modify fraud result
        && !( "aiPricing" in request.resource.data )      // owner cannot modify AI pricing
        && !( "aiTags" in request.resource.data )         // owner cannot fake tags
        && !( "aiDescription" in request.resource.data ); // owner cannot fake descriptions

      // Admins can update everything
      allow update, delete: if isAdmin();
    }

    // -----------------------------------
    // üîç FRAUD EVENTS
    // fraudEvents/{id}
    // Written only by Cloud Functions
    // Read only by admins
    // -----------------------------------
    match /fraudEvents/{id} {
      allow read: if isAdmin();
      allow write: if request.time < timestamp.date(2030, 1, 1)
                   && request.auth == null; // CF uses service account
    }

    // -----------------------------------
    // üìä ANALYTICS
    // adminAnalytics/{id}
    // Only admins
    // -----------------------------------
    match /adminAnalytics/{id} {
      allow read, write: if isAdmin();
    }

    // -----------------------------------
    // üí¨ MESSAGING THREADS
    // threads/{threadId}
    // Each thread contains members, messages, etc.
    // -----------------------------------
    match /threads/{threadId} {
      allow read, write: if isAdmin() || request.auth.uid in resource.data.members;

      match /messages/{messageId} {
        allow read: if isAdmin() || request.auth.uid in resource.data.members;
        allow create: if request.auth.uid in resource.data.members;
        allow delete: if isAdmin();
      }
    }

    // -----------------------------------
    // üí¨ ADMIN ACTION LOGS
    // adminLogs/{logId}
    // -----------------------------------
    match /adminLogs/{logId} {
      allow read, write: if isAdmin();
    }

    // -----------------------------------
    // ü§ñ AI SYSTEM LOGS
    // ai/{doc}
    // Admin only
    // -----------------------------------
    match /ai/{doc} {
      allow read, write: if isAdmin();
    }
  }
}
